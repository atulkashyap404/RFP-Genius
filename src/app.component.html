<main class="min-h-screen bg-gray-900 text-gray-100 p-4 sm:p-6 md:p-8">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <header class="text-center mb-8">
      <h1 class="text-4xl sm:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
        RFP-Genius
      </h1>
      <p class="mt-2 text-lg text-gray-400">
        AI-Powered Proposal Generation from Your Knowledge Base
      </p>
    </header>

    <!-- About Section -->
    <div class="mb-8 max-w-4xl mx-auto">
      <button (click)="toggleAbout()" class="w-full flex justify-between items-center text-left p-3 bg-gray-800 hover:bg-gray-700/80 rounded-lg transition-colors border border-gray-700" title="Click to learn more about this tool">
        <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            <span class="font-semibold text-lg text-gray-200">What is RFP-Genius?</span>
        </div>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform duration-300 text-gray-400" [class.rotate-180]="showAbout()" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      @if (showAbout()) {
        <div class="mt-0 bg-gray-800/60 p-5 rounded-b-lg border-x border-b border-gray-700 animate-fade-in">
          <p class="text-gray-300 leading-relaxed">
            RFP-Genius is an intelligent assistant designed to streamline the Request for Proposal (RFP) process. Simply upload your internal knowledge base documents (in PDF format), and our AI will use them as a single source of truth. Ask any specific question related to your documents, and receive a professionally drafted, context-aware answer instantly. The tool also suggests relevant follow-up questions to help you explore topics more deeply, ensuring your proposals are both comprehensive and accurate.
          </p>
        </div>
      }
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      
      <!-- Left Column: Inputs -->
      <div class="bg-gray-800/50 rounded-xl p-6 shadow-lg border border-gray-700 flex flex-col gap-6">
        <div>
          <h2 class="text-2xl font-bold text-white mb-2">1. Configure API Key</h2>
          <label for="api-key" class="block text-sm font-medium text-gray-300 mb-2">
            Google Gemini API Key
          </label>
          <input
            id="api-key"
            type="password"
            [value]="apiKey()"
            (input)="onApiKeyInput($event)"
            class="w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm p-3 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
            placeholder="Enter your API key"
            title="Your Google Gemini API key. Stored securely for this session only."
          />
          @if (apiKey().trim() === '') {
            <p class="text-xs text-yellow-400 mt-2">
              An API key is required to generate proposals.
            </p>
          }
        </div>
        
        <div>
          <h2 class="text-2xl font-bold text-white mb-2">2. Provide Context</h2>
           <label 
              for="pdf-upload" 
              class="flex flex-col items-center justify-center w-full p-6 bg-gray-900 border-2 border-gray-600 border-dashed rounded-lg cursor-pointer hover:bg-gray-800/50 transition-colors duration-300"
              (dragover)="onDragOver($event)"
              (dragleave)="onDragLeave($event)"
              (drop)="onDrop($event)"
              [class.bg-blue-900/20]="isDraggingOver()"
              [class.border-blue-500]="isDraggingOver()"
              title="Click or drag and drop your PDF knowledge base files here">
            <div class="flex flex-col items-center justify-center text-center">
              <svg class="w-8 h-8 mb-4 text-gray-500" [class.text-blue-400]="isDraggingOver()" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
              </svg>
              <p class="mb-2 text-sm text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
              <p class="text-xs text-gray-500">PDF documents only</p>
            </div>
            <input id="pdf-upload" type="file" class="hidden" multiple accept=".pdf" (change)="onFileSelected($event)" />
          </label>

          @if (fileError(); as err) {
            <div class="mt-2 text-sm text-red-400 bg-red-900/30 p-2 rounded-md border border-red-700/50">
              {{ err }}
            </div>
          }

          @if (selectedFiles(); as files) {
            @if(files.length > 0) {
              <div class="mt-4 space-y-3">
                <div>
                  <h3 class="text-sm font-medium text-gray-400 mb-2">Selected Files:</h3>
                  <ul class="space-y-1">
                    @for (file of arrayFrom(files); track file.name) {
                      <li class="text-xs text-gray-300 bg-gray-700/50 px-2 py-1 rounded flex items-center justify-between gap-2">
                        <div class="flex items-center gap-2 overflow-hidden">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                          <span class="truncate">{{ file.name }}</span>
                        </div>
                        <button (click)="viewPdf(file)" class="text-blue-400 hover:text-blue-300 text-xs font-semibold flex-shrink-0" title="Preview this PDF file">View</button>
                      </li>
                    }
                  </ul>
                </div>
                <div class="flex items-center gap-2">
                  <button (click)="processFiles()" [disabled]="processingFiles()" class="flex-grow py-2 px-4 rounded-lg font-semibold text-white transition-all duration-200 ease-in-out bg-green-600 hover:bg-green-500 disabled:bg-gray-600 disabled:cursor-wait" title="Extract text from the selected PDFs to use as context for the AI">
                    @if (processingFiles()) {
                      <span class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Processing...
                      </span>
                    } @else {
                      <span>Process {{ files.length }} Document(s)</span>
                    }
                  </button>
                  <button (click)="clearFiles()" class="p-2 rounded-lg bg-red-800 hover:bg-red-700 text-white transition-colors" title="Clear selected files">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              </div>
            }
          }

          @if (processingSuccess(); as successMessage) {
            <div class="mt-4 p-3 bg-green-900/50 border border-green-700 text-green-300 text-sm rounded-lg">
              <p class="font-semibold">{{ successMessage }}</p>
              <ul class="mt-2 text-xs list-disc list-inside space-y-1">
                @for(name of processedFileNames(); track name) {
                  <li>{{ name }}</li>
                }
              </ul>
              <button (click)="clearFiles()" class="mt-3 w-full text-xs py-1 px-3 rounded-md bg-gray-700 hover:bg-gray-600 text-gray-300 transition-colors" title="Remove processed documents and start over">
                Clear Files
              </button>
            </div>
          }
        </div>

        <div>
          <h2 class="text-2xl font-bold text-white mb-2">3. Ask Your Question</h2>
          <label for="question" class="block text-sm font-medium text-gray-300 mb-2">
            Enter your specific RFP question
          </label>
          <textarea
            id="question"
            rows="4"
            [value]="question()"
            (input)="onQuestionInput($event)"
            class="w-full bg-gray-900 border border-gray-600 rounded-md shadow-sm p-3 text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150"
            placeholder="e.g., 'Describe your data encryption and compliance policies.' (min. 10 characters)"
            title="Enter the specific question you want the AI to answer based on your documents"
          ></textarea>
        </div>

        <div>
          <h2 class="text-2xl font-bold text-white mb-3">4. Select Output Format</h2>
          <fieldset class="flex flex-wrap items-center gap-4">
            <legend class="sr-only">Output Format</legend>
            <div>
              <input type="radio" id="format-json" name="output-format" value="json" [checked]="outputFormat() === 'json'" (change)="onFormatChange('json')" class="hidden peer">
              <label for="format-json" class="block cursor-pointer rounded-lg border border-gray-600 bg-gray-900 px-4 py-2 text-sm font-medium peer-checked:border-blue-500 peer-checked:ring-1 peer-checked:ring-blue-500 hover:bg-gray-800 transition-colors" title="Output a structured JSON object containing the answer and follow-up questions.">
                Structured
              </label>
            </div>
            <div>
              <input type="radio" id="format-markdown" name="output-format" value="markdown" [checked]="outputFormat() === 'markdown'" (change)="onFormatChange('markdown')" class="hidden peer">
              <label for="format-markdown" class="block cursor-pointer rounded-lg border border-gray-600 bg-gray-900 px-4 py-2 text-sm font-medium peer-checked:border-blue-500 peer-checked:ring-1 peer-checked:ring-blue-500 hover:bg-gray-800 transition-colors" title="Output the answer formatted in Markdown for easy reading.">
                Markdown
              </label>
            </div>
            <div>
              <input type="radio" id="format-text" name="output-format" value="text" [checked]="outputFormat() === 'text'" (change)="onFormatChange('text')" class="hidden peer">
              <label for="format-text" class="block cursor-pointer rounded-lg border border-gray-600 bg-gray-900 px-4 py-2 text-sm font-medium peer-checked:border-blue-500 peer-checked:ring-1 peer-checked:ring-blue-500 hover:bg-gray-800 transition-colors" title="Output the answer in simple plain text.">
                Plain Text
              </label>
            </div>
          </fieldset>
        </div>


        <button
          (click)="generate()"
          [disabled]="isFormInvalid()"
          class="w-full py-3 px-4 rounded-lg font-semibold text-white transition-all duration-200 ease-in-out
                 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500
                 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed disabled:text-gray-400
                 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-blue-500
                 shadow-lg hover:shadow-blue-500/50"
          title="Generate a proposal based on the provided context and your question"
        >
          @if (generating()) {
            <span class="flex items-center justify-center">
              <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Generating...
            </span>
          } @else {
            <span>Generate Proposal</span>
          }
        </button>
      </div>

      <!-- Right Column: Output -->
      <div class="bg-gray-800/50 rounded-xl p-6 shadow-lg border border-gray-700 min-h-[300px] flex items-center justify-center">
        @if (pdfToView(); as file) {
          <app-pdf-viewer [file]="file" class="w-full h-full max-h-[70vh]"></app-pdf-viewer>
        } @else if (processingFiles()) {
          <app-processing-spinner [fileName]="currentlyProcessingFile()"></app-processing-spinner>
        } @else if (generating() && !latestResult()) {
          <app-loading-spinner></app-loading-spinner>
        } @else if (error()) {
          <div class="text-center text-red-400 bg-red-900/50 border border-red-700 rounded-lg p-4">
            <h3 class="font-bold text-lg mb-2">An Error Occurred</h3>
            <p class="text-red-300">{{ error() }}</p>
          </div>
        } @else if (latestResult(); as latest) {
          <div class="w-full animate-fade-in self-start">
            <!-- Latest Result -->
            <div>
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Generated Proposal</h2>
                <div class="flex items-center gap-2">
                  <button (click)="downloadResult()" class="flex items-center gap-2 text-sm bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-3 rounded-lg transition-colors" title="Download the latest proposal as a text file">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Download
                  </button>
                  @if (history().length > 0) {
                    <button (click)="downloadHistory()" class="flex items-center gap-2 text-sm bg-purple-600 hover:bg-purple-500 text-white font-semibold py-2 px-3 rounded-lg transition-colors" title="Download the entire conversation history as a text file">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-4 w-4">
                        <path d="M3.5 3A1.5 1.5 0 0 0 2 4.5v2.256c0 .414.336.75.75.75h14.5a.75.75 0 0 0 .75-.75V4.5A1.5 1.5 0 0 0 16.5 3h-13Z" />
                        <path d="M2 9.25c0 .414.336.75.75.75h14.5a.75.75 0 0 0 .75-.75v-1.111A.75.75 0 0 0 17.25 7H2.75A.75.75 0 0 0 2 7.889v1.361Z" />
                        <path d="M2.75 11h14.5a.75.75 0 0 1 .75.75v3a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 2 14.75v-3a.75.75 0 0 1 .75-.75Z" />
                      </svg>
                      Export History
                    </button>
                  }
                </div>
              </div>
              <div class="bg-gray-900/70 p-4 rounded-lg border border-gray-600 mb-6">
                <h3 class="font-semibold text-lg text-blue-300 mb-2">Answer</h3>
                <p class="text-gray-200 whitespace-pre-wrap">{{ latest.result.answer }}</p>
              </div>
              @if (latest.result.followUpQuestions.length > 0) {
                <div>
                  <button (click)="toggleFollowUps()" class="w-full flex justify-between items-center text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" title="Show or hide suggested follow-up questions">
                    <span class="font-semibold text-lg text-purple-300">Suggested Follow-up Questions</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform duration-300" [class.rotate-180]="!showFollowUps()" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>
                  @if (showFollowUps()) {
                    <div class="mt-3 bg-gray-900/50 p-4 rounded-b-lg border-x border-b border-gray-700">
                      <ul class="space-y-3 list-none pl-2">
                        @for(q of latest.result.followUpQuestions; track q) {
                          <li class="flex items-start">
                            <svg class="h-5 w-5 text-purple-400 mr-3 mt-1 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span class="text-gray-300">{{ q }}</span>
                          </li>
                        }
                      </ul>
                    </div>
                  }
                </div>
              }
            </div>
            
            <!-- History -->
            @if(history().length > 0) {
              <div class="mt-8 pt-6 border-t border-gray-700">
                <button (click)="toggleHistory()" class="w-full flex justify-between items-center text-left p-3 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors" title="Show or hide your past questions and answers">
                  <div class="flex items-center gap-3">
                    <span class="font-semibold text-lg text-gray-300">Conversation History</span>
                    @if (generating()) {
                       <div class="h-4 w-4 animate-spin rounded-full border-2 border-solid border-blue-400 border-t-transparent"></div>
                    }
                  </div>
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 transition-transform duration-300" [class.rotate-180]="!showHistory()" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                 @if (showHistory()) {
                  <div class="mt-3 bg-gray-900/50 p-4 rounded-b-lg border-x border-b border-gray-700 space-y-6">
                    @for(item of history(); track $index) {
                      <div class="border-b border-gray-700 pb-4 last:border-b-0 last:pb-0 animate-fade-in">
                        <div class="mb-3">
                          <h4 class="font-semibold text-sm text-gray-400 mb-1">Your Question:</h4>
                          <p class="text-gray-200 text-sm bg-gray-800/50 p-2 rounded">{{ item.question }}</p>
                        </div>
                        <div>
                          <h4 class="font-semibold text-sm text-gray-400 mb-1">Generated Answer:</h4>
                          <p class="text-gray-300 text-sm whitespace-pre-wrap">{{ item.result.answer }}</p>
                        </div>
                      </div>
                    }
                  </div>
                 }
              </div>
            }
          </div>
        } @else {
          <div class="text-center text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="mt-2 font-semibold">Your generated proposal will appear here.</p>
            <p class="text-sm">Fill in the details on the left and click "Generate".</p>
          </div>
        }
      </div>
    </div>
  </div>
</main>